<%- include('../partials/head.ejs', { title: 'USA - Category Admin' }) %>

<style>
    body {
        background-color: #000000;
    }
    #vehicle-type-selector option,
    #published-vehicle-type-selector option {
        background-color: white;
        color: black;
    }
    #vehicle-type-selector option:hover,
    #published-vehicle-type-selector option:hover {
        background-color: #DC2626;
        color: white;
    }
    .border-bottom-left-to-right {
        position: relative;
        border-radius: 0.75rem;
    }
    .border-bottom-left-to-right:hover::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background-color: #DC2626;
        animation: borderLeftToRight 0.3s ease-in-out forwards;
    }
    @keyframes borderLeftToRight {
        to {
            width: 100%;
        }
    }
    .icon-button {
        transition: transform 0.2s;
    }
    .icon-button:hover {
        transform: scale(1.1);
    }
    .filter-button:hover {
        background-color: #DC2626;
        color: #FFFFFF;
    }
    #mobile-menu-overlay {
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        opacity: 0;
        width: 16rem;
        height: 100%;
        z-index: 1000;
        pointer-events: auto;
        will-change: transform, opacity;
    }
    .mobile-menu-open {
        transform: translateX(0);
        opacity: 1;
    }
    #mobile-menu-backdrop {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        pointer-events: auto;
    }
    #mobile-menu-backdrop.active {
        display: block;
    }
</style>
</head>
<body class="min-h-screen flex flex-col text-white font-['Poppins'] bg-black">

<%- include('../partials/navbar') %>

<!-- Subnavbar -->
<nav class="bg-gray-800 py-4">
    <div class="container mx-auto px-4 flex justify-center space-x-6">
        <a href="/admin/category" class="text-white text-lg font-semibold hover:text-red-600 transition border-b-2 border-red-600">Category</a>
        <a href="/admin/brand" class="text-white text-lg font-semibold hover:text-red-600 transition">Brands</a>
        <a href="/admin/model" class="text-white text-lg font-semibold hover:text-red-600 transition">Model</a>
        <a href="/admin/article" class="text-white text-lg font-semibold hover:text-red-600 transition">Article</a>
    </div>
</nav>

<!-- Main Section -->
<main class="flex-grow container mx-auto px-4 py-8 max-w-screen-2xl bg-black">
    <!-- Upload Category Section -->
    <section class="mb-16">
        <h2 class="text-3xl font-bold text-white mb-6">Upload Your Category</h2>

        <!-- Category Creation Form -->
        <form id="category-form" action="/admin/category" method="POST" enctype="multipart/form-data" class="space-y-6 bg-gray-800 p-6 rounded-lg shadow-lg">
            <div>
                <label for="category-image" class="block text-sm font-medium text-gray-300 mb-1">Category Image</label>
                <input type="file" id="category-image" name="categoryImage" accept="image/*" required class="w-full text-white bg-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700">
            </div>
            <div>
                <label for="category-name" class="block text-sm font-medium text-gray-300 mb-1">Category Name</label>
                <input type="text" id="category-name" name="categoryName" placeholder="Enter category name" required class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white">
            </div>
            <div>
                <label for="vehicle-type" class="block text-sm font-medium text-gray-300 mb-1">Vehicle Type</label>
                <select id="vehicle-type" name="vehicleType" required class="w-full bg-gray-700 text-white text-lg font-semibold px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600">
                    <option value="" disabled selected>Select Vehicle Type</option>
                    <% vehicleTypes.forEach(type => { %>
                        <option value="<%= type.vechicle_type_id %>"><%= type.vechicle_type_name %></option>
                    <% }) %>
                </select>
            </div>
            <button type="submit" id="submit-category-btn" class="w-full bg-red-600 text-white text-lg font-semibold px-6 py-2 rounded-lg shadow-lg hover:bg-red-700 transition">Create or Publish Category</button>
        </form>
    </section>

    <!-- Already Published Categories -->
    <section>
        <h2 class="text-3xl font-bold text-white mb-6">Already Published Category</h2>
        <select id="published-vehicle-type-selector" class="w-full max-w-xs bg-gray-700 text-white text-lg font-semibold px-4 py-2 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-red-600">
            <option value="" selected>All Vehicle Types</option>
            <% vehicleTypes.forEach(type => { %>
                <option value="<%= type.vechicle_type_id %>"><%= type.vechicle_type_name %></option>
            <% }) %>
        </select>
        <div id="published-category-boxes" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
            <% categories.forEach(cat => { %>
                <div class="bg-gradient-to-b from-red-500 to-black rounded-xl shadow-xl transition-all duration-300 p-5 flex flex-col items-center text-center border-bottom-left-to-right shadow-md hidden" data-vehicle-type="<%= cat.vehicle_type_id %>">
                    <div class="w-full h-32 bg-white rounded-lg mb-4 shadow-inner border-transparent">
                        <img src="<%= cat.image_path %>" alt="<%= cat.name %>" class="w-full h-full object-cover rounded-lg">
                    </div>
                    <div class="text-white font-semibold text-lg line-clamp-1"><b><%= cat.name %></b></div>
                    <div class="text-gray-300 text-sm">By <%= cat.author_name %></div>
                    <div class="flex justify-center space-x-2 mt-2">
                        <button class="edit-cat-btn bg-blue-600 text-white px-4 py-1 rounded-lg hover:bg-blue-700 transition" data-cat-id="<%= cat.category_id %>">Edit</button>
                        <button class="delete-cat-btn bg-red-600 text-white px-4 py-1 rounded-lg hover:bg-red-700 transition" data-cat-id="<%= cat.category_id %>">Delete</button>
                    </div>
                </div>
            <% }) %>
        </div>
    </section>
</main>

<%- include('../partials/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM fully loaded');

        // Mobile Menu Toggle
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
        const closeMobileMenuButton = document.getElementById('close-mobile-menu');

        if (!mobileMenuButton || !mobileMenuOverlay || !mobileMenuBackdrop || !closeMobileMenuButton) {
            console.error('Mobile menu elements missing:', {
                mobileMenuButton: !!mobileMenuButton,
                mobileMenuOverlay: !!mobileMenuOverlay,
                mobileMenuBackdrop: !!mobileMenuBackdrop,
                closeMobileMenuButton: !!closeMobileMenuButton
            });
            return;
        }

        const toggleMenu = () => {
            console.log('Toggling menu');
            mobileMenuOverlay.classList.toggle('mobile-menu-open');
            mobileMenuBackdrop.classList.toggle('active');
        };

        mobileMenuButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Hamburger menu clicked');
            toggleMenu();
        }, { passive: false });

        mobileMenuButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Hamburger menu touched');
            toggleMenu();
        }, { passive: false });

        closeMobileMenuButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Close menu clicked');
            mobileMenuOverlay.classList.remove('mobile-menu-open');
            mobileMenuBackdrop.classList.remove('active');
        }, { passive: false });

        mobileMenuBackdrop.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Backdrop clicked, closing menu');
            mobileMenuOverlay.classList.remove('mobile-menu-open');
            mobileMenuBackdrop.classList.remove('active');
        }, { passive: false });

        mobileMenuOverlay.addEventListener('click', (e) => {
            e.stopPropagation();
            console.log('Clicked inside menu, preventing close');
        }, { passive: false });

        // Search Functionality (Placeholder)
        document.getElementById('search-button')?.addEventListener('click', () => {
            const query = document.getElementById('search-input')?.value;
            console.log('Search button clicked, query:', query);
            if (query) {
                alert('Search for: ' + query);
            } else {
                alert('Please enter a search query.');
            }
        });

        // Highlight Active Nav Link
        const navLinks = document.querySelectorAll('#desktop-nav-links a, .mobile-nav-link');
        const currentPath = window.location.pathname;
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.classList.add('bg-red-600', 'text-white');
                link.classList.remove('hover:bg-red-600');
            }
        });

        // Category Creation Form Submission with AJAX
        const categoryForm = document.getElementById('category-form');
        if (categoryForm) {
            categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(categoryForm);

                try {
                    const response = await fetch('/admin/category', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert(result.message);
                        categoryForm.reset(); // Reset form
                        window.location.reload(); // Reload to show new category
                    } else {
                        alert(result.message || 'Failed to create category.');
                    }
                } catch (error) {
                    console.error('Error submitting category form:', error);
                    alert('An error occurred while creating the category.');
                }
            });
        }

        // Published Categories Filter
        const publishedVehicleTypeSelector = document.getElementById('published-vehicle-type-selector');
        const publishedCategoryBoxes = document.querySelectorAll('#published-category-boxes > div');

        publishedVehicleTypeSelector.addEventListener('change', (e) => {
            const selectedVehicleType = e.target.value;
            publishedCategoryBoxes.forEach(box => {
                const boxVehicleType = box.getAttribute('data-vehicle-type');
                if (selectedVehicleType === '' || selectedVehicleType === boxVehicleType) {
                    box.classList.remove('hidden');
                } else {
                    box.classList.add('hidden');
                }
            });
        });

        // Initial Display of Categories
        publishedCategoryBoxes.forEach(box => {
            const boxVehicleType = box.getAttribute('data-vehicle-type');
            if (publishedVehicleTypeSelector.value === '' || publishedVehicleTypeSelector.value === boxVehicleType) {
                box.classList.remove('hidden');
            }
        });

        // Event Delegation for Edit and Delete Buttons
        publishedCategoryBoxes.forEach(box => {
            box.addEventListener('click', async (e) => {
                if (e.target.classList.contains('edit-cat-btn')) {
                    const catId = e.target.getAttribute('data-cat-id');
                    console.log('Edit button clicked for category ID:', catId);
                    try {
                        const response = await fetch(`/admin/category/${catId}`);
                        const data = await response.json();
                        if (data.success && data.category) {
                            const category = data.category;
                            const editForm = document.createElement('div');
                            editForm.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                            editForm.innerHTML = `
                                <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl">
                                    <h3 class="text-2xl font-bold text-white mb-4">Edit Category</h3>
                                    <form id="edit-category-form" enctype="multipart/form-data" class="space-y-6">
                                        <input type="hidden" name="categoryId" value="${category.category_id}">
                                        <div>
                                            <label for="edit-category-image" class="block text-sm font-medium text-gray-300 mb-1">Category Image</label>
                                            <img src="${category.image_path}" alt="${category.name}" class="w-48 h-32 object-contain rounded-md mb-2">
                                            <input type="file" id="edit-category-image" name="categoryImage" accept="image/*" class="w-full text-white bg-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700">
                                        </div>
                                        <div>
                                            <label for="edit-category-name" class="block text-sm font-medium text-gray-300 mb-1">Category Name</label>
                                            <input type="text" id="edit-category-name" name="categoryName" value="${category.name}" required class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white">
                                        </div>
                                        <div>
                                            <label for="edit-vehicle-type" class="block text-sm font-medium text-gray-300 mb-1">Vehicle Type</label>
                                            <select id="edit-vehicle-type" name="vehicleType" required class="w-full bg-gray-700 text-white text-lg font-semibold px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600">
                                                <!-- Options will be populated dynamically -->
                                            </select>
                                        </div>
                                        <div class="flex justify-between">
                                            <button type="button" class="close-edit-form bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">Cancel</button>
                                            <button type="submit" class="submit-edit-form bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Update Category</button>
                                        </div>
                                    </form>
                                </div>
                            `;
                            document.body.appendChild(editForm);

                            // Populate vehicle types dynamically
                            const vehicleTypeSelect = editForm.querySelector('#edit-vehicle-type');
                            vehicleTypeSelect.innerHTML = ''; // Clear existing options
                            <% vehicleTypes.forEach(type => { %>
                                vehicleTypeSelect.innerHTML += `<option value="<%= type.vechicle_type_id %>" ${category.vehicle_type_id === <%= type.vechicle_type_id %> ? 'selected' : ''}><%= type.vechicle_type_name %></option>`;
                            <% }); %>

                            // Close button functionality
                            editForm.querySelector('.close-edit-form').addEventListener('click', () => {
                                console.log('Close edit form clicked');
                                editForm.remove();
                            });

                            // Form submission
                            editForm.querySelector('#edit-category-form').addEventListener('submit', async (e) => {
                                e.preventDefault();
                                const formData = new FormData(e.target);
                                try {
                                    const response = await fetch('/admin/category/update', {
                                        method: 'POST',
                                        body: formData
                                    });
                                    const result = await response.json();
                                    if (result.success) {
                                        alert(result.message);
                                        editForm.remove();
                                        window.location.reload();
                                    } else {
                                        alert(result.message || 'Failed to update category.');
                                    }
                                } catch (error) {
                                    console.error('Error updating category:', error);
                                    alert('Failed to update category.');
                                }
                            });
                        } else {
                            alert(data.message || 'Failed to load category details.');
                        }
                    } catch (error) {
                        console.error('Error fetching category:', error);
                        alert('Failed to load category details.');
                    }
                }

                if (e.target.classList.contains('delete-cat-btn')) {
                    const catId = e.target.getAttribute('data-cat-id');
                    console.log('Delete button clicked for category ID:', catId);
                    if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
                        try {
                            const response = await fetch('/admin/category/delete', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ categoryId: catId })
                            });
                            const result = await response.json();
                            if (result.success) {
                                alert(result.message);
                                e.target.closest('.bg-gradient-to-b').remove();
                            } else {
                                alert(result.message || 'Failed to delete category.');
                            }
                        } catch (error) {
                            console.error('Error deleting category:', error);
                            alert('Failed to delete category.');
                        }
                    }
                }
            });
        });
    });
</script>
</body>
</html>