<%- include('../partials/head.ejs', { title: 'articleadmin' }) %>

<style>
    body { background-color: #000000; }
    select option { background-color: white; color: black; }
    select option:hover { background-color: #DC2626; color: white; }
    .border-bottom-left-to-right { position: relative; border-radius: 0.75rem; }
    .border-bottom-left-to-right:hover::after {
        content: ""; position: absolute; bottom: 0; left: 0; width: 0; height: 2px;
        background-color: #DC2626; animation: borderLeftToRight 0.3s ease-in-out forwards;
    }
    @keyframes borderLeftToRight { to { width: 100%; } }
    .icon-button { transition: transform 0.2s; }
    .icon-button:hover { transform: scale(1.1); }
    .modal-content { max-height: 90vh; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #DC2626 #1F2937; }
    .modal-content::-webkit-scrollbar { width: 6px; }
    .modal-content::-webkit-scrollbar-track { background: #1F2937; }
    .modal-content::-webkit-scrollbar-thumb { background: #DC2626; border-radius: 3px; }

    /* FIX 2: Image fit inside box */
    .article-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 0.5rem;
    }
</style>
</head>
<body class="min-h-screen flex flex-col text-white font-['Poppins'] bg-black">
<%- include('../partials/navbar') %>

<nav class="bg-gray-800 py-4">
    <div class="container mx-auto px-4 flex justify-center space-x-6">
        <a href="/admin/category" class="text-white text-lg font-semibold hover:text-red-600 transition">Category</a>
        <a href="/admin/brand" class="text-white text-lg font-semibold hover:text-red-600 transition">Brands</a>
        <a href="/admin/model" class="text-white text-lg font-semibold hover:text-red-600 transition">Model</a>
        <a href="/admin/article" class="text-white text-lg font-semibold hover:text-red-600 transition border-b-2 border-red-600">Article</a>
    </div>
</nav>

<main class="flex-grow container mx-auto px-4 py-8 max-w-screen-2xl bg-black">
    <section class="mb-16">
        <h2 class="text-3xl font-bold text-white mb-6">Publish Article</h2>
        <form id="article-form" enctype="multipart/form-data" class="space-y-6 bg-gray-800 p-6 rounded-lg shadow-lg">
            <div>
                <label for="article-title" class="block text-sm font-medium text-gray-300 mb-1">Upload the Title</label>
                <input type="text" id="article-title" name="articleTitle" placeholder="Enter Article Title" required class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white">
            </div>
            
            <!-- UPDATE 1: Sources field added -->
            <div>
                <label for="article-sources" class="block text-sm font-medium text-gray-300 mb-1">Sources/References</label>
                <textarea id="article-sources" name="sources" placeholder="Enter article sources and references (website links, etc.)" class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" rows="3"></textarea>
            </div>
            
            <div>
                <label for="main-image" class="block text-sm font-medium text-gray-300 mb-1">Main Image</label>
                <input type="file" id="main-image" name="mainImage" accept="image/*" required class="w-full text-white bg-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700">
            </div>
            <div class="border border-gray-600 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-white mb-4">Article Content</h3>
                <div class="flex space-x-4 mb-4">
                    <button type="button" id="article-icon" class="icon-button bg-gray-700 p-2 rounded-full hover:bg-red-600 transition" title="Add Article">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </button>
                    <button type="button" id="photo-icon" class="icon-button bg-gray-700 p-2 rounded-full hover:bg-red-600 transition" title="Add Photo">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    </button>
                    <button type="button" id="link-icon" class="icon-button bg-gray-700 p-2 rounded-full hover:bg-red-600 transition" title="Add Link">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                    </button>
                    <button type="button" id="title-icon" class="icon-button bg-gray-700 p-2 rounded-full hover:bg-red-600 transition" title="Add Sub Title">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    </button>
                </div>
                <div id="content-area" class="relative"></div>
            </div>
            <button type="submit" class="w-full bg-red-600 text-white text-lg font-semibold px-6 py-2 rounded-lg shadow-lg hover:bg-red-700 transition">Publish Article</button>
        </form>
    </section>

    <section>
        <h2 class="text-3xl font-bold text-white mb-6">Already Published Articles</h2>
        <div id="published-article-boxes" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <% articles.forEach(article => { %>
            <div class="p-2 rounded-xl bg-gradient-to-b from-red-600 to-black shadow-lg border-bottom-left-to-right news-card">
                <div class="flex flex-row items-center p-2 rounded-xl">
                    <!-- FIX 2: Image fits perfectly -->
                    <div class="article-image w-32 h-32 bg-gray-800 rounded-lg flex-shrink-0 overflow-hidden">
                        <img src="<%= article.Article_main_image %>" alt="<%= article.Article_title %>" class="w-full h-full object-cover rounded-lg">
                    </div>
                    <div class="content ml-4 flex-grow text-white">
                        <div class="article-title text-lg sm:text-2xl font-semibold mb-2"><%= article.Article_title %></div>
                        <div class="date font-semibold"><%= new Date(article.published_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></div>
                    </div>
                </div>
                <div class="flex space-x-2 mt-4 justify-center">
                    <button onclick="openEditModal(<%= JSON.stringify(article) %>)" class="bg-blue-600 text-white px-4 py-1 rounded-lg hover:bg-blue-700 transition">Edit</button>
                    <button onclick="deleteArticle(<%= article.Article_id %>)" class="bg-red-600 text-white px-4 py-1 rounded-lg hover:bg-red-700 transition">Delete</button>
                </div>
            </div>
            <% }) %>
        </div>
    </section>
</main>

<!-- EDIT MODAL -->
<div id="edit-article-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="modal-content bg-gray-800 rounded-lg shadow-lg w-full max-w-2xl">
        <div class="p-6">
            <h3 class="text-2xl font-bold text-white mb-6">Edit Article</h3>
            <form id="edit-article-form" enctype="multipart/form-data" class="space-y-6">
                <div>
                    <label for="edit-article-title" class="block text-sm font-medium text-gray-300 mb-1">Title</label>
                    <input type="text" id="edit-article-title" name="articleTitle" required class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white">
                </div>
                
                <!-- UPDATE 1: Sources field in edit form -->
                <div>
                    <label for="edit-article-sources" class="block text-sm font-medium text-gray-300 mb-1">Sources/References</label>
                    <textarea id="edit-article-sources" name="sources" placeholder="Enter article sources and references (website links, etc.)" class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" rows="3"></textarea>
                </div>
                
                <div>
                    <label for="edit-main-image" class="block text-sm font-medium text-gray-300 mb-1">Main Image</label>
                    <input type="file" id="edit-main-image" name="mainImage" accept="image/*" class="w-full text-white bg-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700">
                    <!-- FIX 2: Show existing image properly -->
                    <div id="edit-main-image-preview" class="mt-2"></div>
                </div>
                <div class="border border-gray-600 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-white mb-4">Content</h3>
                    <div class="flex space-x-4 mb-4">
                        <button type="button" id="edit-article-icon" class="icon-button bg-gray-700 p-2 rounded-full hover:bg-red-600 transition" title="Add Article">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </button>
                        <button type="button" id="edit-photo-icon" class="icon-button bg-gray-700 p-2 rounded-full hover:bg-red-600 transition" title="Add Photo">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        </button>
                        <button type="button" id="edit-link-icon" class="icon-button bg-gray-700 p-2 rounded-full hover:bg-red-600 transition" title="Add Link">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                        </button>
                        <button type="button" id="edit-title-icon" class="icon-button bg-gray-700 p-2 rounded-full hover:bg-red-600 transition" title="Add Sub Title">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                    <div id="edit-content-area" class="relative"></div>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-red-600 text-white text-lg font-semibold px-6 py-2 rounded-lg shadow-lg hover:bg-red-700 transition">Update</button>
                    <button type="button" id="close-edit-modal" class="flex-1 bg-gray-600 text-white text-lg font-semibold px-6 py-2 rounded-lg shadow-lg hover:bg-gray-700 transition">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const contentArea = document.getElementById('content-area');
    const editContentArea = document.getElementById('edit-content-area');
    let currentEditId = null;

    function createBlock(type, html, parent = contentArea, label = '') {
        const div = document.createElement('div');
        div.className = 'relative mb-4 border border-gray-600 p-3 rounded-lg bg-gray-700';
        div.dataset.type = type;

        const labelHtml = label ? `<div class="text-xs font-semibold text-red-400 mb-1 uppercase">${label}</div>` : '';
        div.innerHTML = labelHtml + html + `
            <button class="remove-content-btn absolute top-2 right-2 text-red-600 hover:text-red-700" title="Remove">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>`;
        div.querySelector('.remove-content-btn').onclick = () => div.remove();
        parent.appendChild(div);
        return div;
    }

    ['article', 'photo', 'link', 'title'].forEach(type => {
        const labelMap = { article: 'Article', photo: 'Photo', link: 'Link', title: 'Subtitle' };
        document.getElementById(`${type}-icon`).onclick = () => {
            const htmls = {
                article: `<textarea class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" rows="6" placeholder="Enter Article Content"></textarea>`,
                photo: `<input type="file" name="contentImages" accept="image/*" class="w-full text-white bg-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700">
                        <input type="text" class="w-full px-4 py-2 mt-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Image Source">`,
                link: `<input type="text" class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Link">`,
                subtitle: `<input type="text" class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Sub Title">`
            };
            createBlock(type === 'title' ? 'subtitle' : type, htmls[type === 'title' ? 'subtitle' : type], contentArea, labelMap[type]);
        };

        document.getElementById(`edit-${type}-icon`).onclick = () => {
            const htmls = {
                article: `<textarea class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" rows="6" placeholder="Enter Article Content"></textarea>`,
                photo: `<input type="file" name="contentImages" accept="image/*" class="w-full text-white bg-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700">
                        <input type="text" class="w-full px-4 py-2 mt-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Image Source">`,
                link: `<input type="text" class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Link">`,
                subtitle: `<input type="text" class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Sub Title">`
            };
            createBlock(type === 'title' ? 'subtitle' : type, htmls[type === 'title' ? 'subtitle' : type], editContentArea, labelMap[type]);
        };
    });

    function getContents(area) {
        const blocks = [];
        area.querySelectorAll('div[data-type]').forEach(div => {
            const type = div.dataset.type;
            if (type === 'article' || type === 'subtitle' || type === 'link') {
                blocks.push({ type, value: div.querySelector('textarea, input[type="text"]').value });
            } else if (type === 'photo') {
                const file = div.querySelector('input[type="file"]').files[0];
                const source = div.querySelector('input[type="text"]').value;
                blocks.push({ type: 'photo', image_source: source });
            }
        });
        return blocks;
    }

    document.getElementById('article-form').onsubmit = async e => {
        e.preventDefault();
        const fd = new FormData();
        fd.append('articleTitle', document.getElementById('article-title').value);
        fd.append('sources', document.getElementById('article-sources').value); // UPDATE: Added sources
        const main = document.getElementById('main-image').files[0];
        if (main) fd.append('mainImage', main);
        fd.append('contentData', JSON.stringify(getContents(contentArea)));
        contentArea.querySelectorAll('input[type="file"]').forEach(f => { if (f.files[0]) fd.append('contentImages', f.files[0]); });

        const res = await fetch('/admin/article', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.success) location.reload(); else alert(data.error || 'Error');
    };

    window.openEditModal = article => {
        currentEditId = article.Article_id;
        document.getElementById('edit-article-title').value = article.Article_title;
        document.getElementById('edit-article-sources').value = article.sources || ''; // UPDATE: Added sources
        // FIX 2: Show existing image properly with correct path
        const mainImagePath = article.Article_main_image.startsWith('/uploads/articles/') 
            ? article.Article_main_image 
            : `/uploads/articles/${article.Article_main_image}`;
        document.getElementById('edit-main-image-preview').innerHTML = `<img src="${mainImagePath}" class="w-32 h-32 object-contain rounded-lg">`;
        editContentArea.innerHTML = '';

        article.contents.forEach(c => {
            if (c.type === 'article') {
                createBlock('article', `<textarea class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" rows="6">${c.value}</textarea>`, editContentArea, 'Article');
            } else if (c.type === 'photo') {
                // FIX 2: Show existing content images properly
                const imagePath = c.image_path && c.image_path.startsWith('/uploads/articles/') 
                    ? c.image_path 
                    : `/uploads/articles/${c.image_path}`;
                const imgHtml = c.image_path ? `<div class="mt-2"><img src="${imagePath}" class="w-full max-h-48 object-contain rounded-lg"></div>` : '';
                createBlock('photo', `
                    <input type="file" name="contentImages" accept="image/*" class="w-full text-white bg-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700">
                    <input type="text" class="w-full px-4 py-2 mt-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Image Source" value="${c.image_source || ''}">
                    ${imgHtml}
                `, editContentArea, 'Photo');
            } else if (c.type === 'link') {
                createBlock('link', `<input type="text" class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Link" value="${c.value}">`, editContentArea, 'Link');
            } else if (c.type === 'subtitle') {
                createBlock('subtitle', `<input type="text" class="w-full px-4 py-2 bg-gray-700 border border-red-600 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 text-white" placeholder="Enter Sub Title" value="${c.value}">`, editContentArea, 'Subtitle');
            }
        });

        document.getElementById('edit-article-modal').classList.remove('hidden');
    };

    document.getElementById('edit-article-form').onsubmit = async e => {
        e.preventDefault();
        const fd = new FormData();
        fd.append('articleTitle', document.getElementById('edit-article-title').value);
        fd.append('sources', document.getElementById('edit-article-sources').value); // UPDATE: Added sources
        const main = document.getElementById('edit-main-image').files[0];
        if (main) fd.append('mainImage', main);
        fd.append('contentData', JSON.stringify(getContents(editContentArea)));
        editContentArea.querySelectorAll('input[type="file"]').forEach(f => { if (f.files[0]) fd.append('contentImages', f.files[0]); });

        const res = await fetch(`/admin/article/${currentEditId}`, { method: 'PUT', body: fd });
        const data = await res.json();
        if (data.success) location.reload(); else alert('Update failed');
    };

    window.deleteArticle = async id => {
        if (confirm('Delete this article?')) {
            const res = await fetch(`/admin/article/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) location.reload();
        }
    };

    document.getElementById('close-edit-modal').onclick = () => {
        document.getElementById('edit-article-modal').classList.add('hidden');
        editContentArea.innerHTML = '';
    };
});
</script>
</body>
</html>