<%- include('../partials/head.ejs', { 
    title: 'Compare Vehicles - Side-by-Side Comparison | Gyarage',
    description: 'Compare multiple vehicles side-by-side. View detailed specifications, features, prices and make informed decisions.',
    keywords: 'vehicle comparison, car compare, bike compare, specifications comparison, feature comparison',
    canonical: '/compare'
}) %>

<style>
    body {
        background-color: #000000;
        color: #FFFFFF;
    }
    .border-bottom-left-to-right {
        position: relative;
        border-radius: 0.75rem;
    }
    .border-bottom-left-to-right:hover::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background-color: #DC2626;
        animation: borderLeftToRight 0.3s ease-in-out forwards;
    }
    @keyframes borderLeftToRight {
        to {
            width: 100%;
        }
    }
    
    /* Comparison Table Styles */
    .comparison-table {
        background: #000000;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #ffffff;
    }
    
    .spec-row {
        border-bottom: 1px solid #ffffff;
        transition: background-color 0.3s ease;
    }
    
    .spec-row:hover {
        background-color: #1a1a1a;
    }
    
    .spec-name {
        background-color: #000000;
        font-weight: 600;
        padding: 1rem;
        border-right: 1px solid #ffffff;
        color: #ffffff;
    }
    
    .spec-value {
        padding: 1rem;
        text-align: center;
        color: #ffffff;
    }
    
    .tick {
        color: #22c55e;
        font-weight: bold;
        background-color: #000000;
        border: 1px solid #22c55e;
        padding: 2px 6px;
        border-radius: 4px;
    }
    
    .cross {
        color: #ef4444;
        font-weight: bold;
        background-color: #000000;
        border: 1px solid #ef4444;
        padding: 2px 6px;
        border-radius: 4px;
    }
    
    .vehicle-header {
        background: #000000;
        padding: 1.5rem;
        text-align: center;
        border-bottom: 2px solid #ffffff;
        border-right: 1px solid #ffffff;
        min-width: 200px;
        color: #ffffff;
    }
    
    .vehicle-name {
        font-weight: bold;
        font-size: 1.1rem;
        color: #ffffff;
    }
    
    .vehicle-brand {
        font-size: 0.9rem;
        color: #ffffff;
        margin-top: 0.25rem;
    }
    
    .score-cell {
        font-weight: bold;
        font-size: 1.1rem;
        color: #ffffff;
    }
    
    .winner-cell {
        background-color: #000000;
        border: 2px solid #22c55e;
    }
    
    .conclusion-box {
        background: #000000;
        border-radius: 12px;
        padding: 2rem;
        margin-top: 2rem;
        border: 1px solid #ffffff;
    }
    
    .recommendation-card {
        background: #000000;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #ffffff;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .recommendation-card:hover {
        border-color: #DC2626;
        transform: translateY(-2px);
    }
    
    .loading-spinner {
        border: 3px solid #ffffff;
        border-top: 3px solid #DC2626;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .model-selector {
        background: #000000;
        border: 1px solid #ffffff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .selection-row {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
    }
    
    .selection-group {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 150px;
    }
    
    .selection-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #ffffff;
        font-size: 0.9rem;
    }
    
    .selection-dropdown {
        background: #000000;
        border: 1px solid #ffffff;
        border-radius: 6px;
        padding: 0.5rem;
        color: #ffffff;
        font-size: 0.9rem;
        height: 40px;
    }
    
    .selection-dropdown:focus {
        outline: none;
        border-color: #DC2626;
    }
    
    .selection-dropdown:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .selected-model-display {
        background: #1a1a1a;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border: 1px solid #ffffff;
    }
    
    .selected-model-image {
        width: 60px;
        height: 45px;
        object-fit: cover;
        border-radius: 6px;
        margin-right: 1rem;
        border: 1px solid #ffffff;
    }
    
    .remove-model-btn {
        background: #DC2626;
        color: #ffffff;
        border: none;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }
    
    .remove-model-btn:hover {
        background: #b91c1c;
    }
    
    .compact-layout {
        display: flex;
        align-items: start;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .vehicle-number {
        background: #DC2626;
        color: #ffffff;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
        flex-shrink: 0;
    }
    
    .compare-button {
        background: #DC2626;
        color: #ffffff;
        border: 1px solid #DC2626;
    }
    
    .compare-button:hover {
        background: #b91c1c;
        border-color: #b91c1c;
    }
    
    .share-button {
        background: #000000;
        color: #ffffff;
        border: 1px solid #ffffff;
    }
    
    .share-button:hover {
        background: #1a1a1a;
        border-color: #DC2626;
    }
    
    .winner-text {
        color: #22c55e;
        font-weight: bold;
    }
    
    @media (max-width: 768px) {
        .selection-row {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .selection-group {
            min-width: 100%;
        }
        
        .vehicle-header {
            min-width: 150px;
        }
        
        .compact-layout {
            flex-direction: column;
        }
    }
</style>
</head>
<body class="min-h-screen flex flex-col text-white font-['Poppins']" style="background-color: #000000;">
    
<%- include('../partials/navbar') %>

    <!-- Main Section -->
    <main class="flex-grow container mx-auto px-4 py-4 max-w-screen-2xl" style="background-color: #000000;">
        <!-- Breadcrumb -->
        <div class="breadcrumb text-white text-sm sm:text-base flex items-center mb-4">
            <a href="/" class="hover:text-red-600">Gyarage</a> 
            <span class="mx-2 text-red-600">&gt;&gt;</span> 
            <a href="/compare" class="text-red-600 font-bold">Compare</a>
        </div>

        <!-- Compare Section -->
        <section class="mb-16">
            <div class="bg-gradient-to-b from-red-600 to-black text-white rounded-md flex items-center justify-start text-3xl font-bold mb-6 shadow-lg h-12 px-4 sm:px-6">
                <b>Compare Vehicles</b>
            </div>
            
            <div class="bg-gradient-to-b from-red-600 to-black text-white rounded-xl shadow-xl p-6 lg:p-10 border-bottom-left-to-right">
                <!-- Vehicle Selection -->
                <div class="howmany flex flex-col md:flex-row items-center justify-center md:justify-start space-y-4 md:space-y-0 md:space-x-8 text-xl sm:text-2xl font-bold mb-8">
                    <span>How many vehicles you want to compare?</span>
                    <div class="relative inline-block w-40">
                        <select id="vehicle-count" name="vehicle-count" class="w-full h-12 rounded-lg bg-white text-black font-semibold text-lg border-2 border-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 pr-10 pl-4">
                            <option value="2">2 Vehicles</option>
                            <option value="3">3 Vehicles</option>
                            <option value="4">4 Vehicles</option>
                        </select>
                    </div>
                </div>

                <!-- Vehicle Selection Containers -->
                <div id="vehicle-selection" class="space-y-4 mb-8">
                    <!-- Vehicle selection boxes will be dynamically generated here -->
                </div>

                <!-- Compare Button -->
                <button id="compare-button" class="w-full md:w-auto compare-button font-bold py-3 px-8 rounded-lg transition duration-300 text-lg flex items-center justify-center mx-auto">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Compare Selected Vehicles
                </button>
            </div>
        </section>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="loading-spinner" style="display: none;"></div>

        <!-- Comparison Results -->
        <section id="comparison-results" style="display: none;">
            <!-- Comparison Table -->
            <div class="mb-12">
                <div class="bg-gradient-to-b from-red-600 to-black text-white rounded-md flex items-center justify-start text-3xl font-bold mb-6 shadow-lg h-12 px-4 sm:px-6">
                    <b id="comparison-title">Comparison Results</b>
                </div>
                
                <div class="comparison-table overflow-x-auto">
                    <table class="w-full min-w-[800px]">
                        <thead>
                            <tr id="comparison-header">
                                <th class="vehicle-header">Specifications</th>
                                <!-- Vehicle headers will be dynamically added here -->
                            </tr>
                        </thead>
                        <tbody id="comparison-body">
                            <!-- Comparison rows will be dynamically added here -->
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #000000;">
                                <td class="spec-name font-bold text-lg">Total Score</td>
                                <!-- Score cells will be dynamically added here -->
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Conclusion Box -->
            <div class="conclusion-box mb-12">
                <h3 class="text-2xl font-bold mb-4 text-white">Comparison Conclusion</h3>
                <div id="conclusion-content">
                    <!-- Conclusion content will be dynamically added here -->
                </div>
            </div>

            <!-- Share Section -->
            <div class="text-center mb-12">
                <button id="share-button" class="share-button font-bold py-3 px-8 rounded-lg transition duration-300 text-lg flex items-center justify-center mx-auto">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    Share This Comparison
                </button>
            </div>
        </section>

        <!-- Recommended Products -->
        <section class="mt-16">
            <div class="bg-gradient-to-b from-red-600 to-black text-white rounded-md flex items-center justify-start text-3xl font-bold mb-6 shadow-lg h-12 px-4 sm:px-6">
                <b>Recommended Vehicles</b>
            </div>
            <div id="recommended-vehicles" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Recommended vehicles will be dynamically loaded here -->
            </div>
        </section>
    </main>

<%- include('../partials/footer') %>

<script>
    // Global variables
    let selectedModels = [];
    let vehicleTypes = <%- JSON.stringify(vehicleTypes || []) %>;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeVehicleSelection();
        loadRecommendedVehicles();
        setupEventListeners();
    });

    // Initialize vehicle selection boxes
    function initializeVehicleSelection() {
        const vehicleCount = document.getElementById('vehicle-count');
        const vehicleSelection = document.getElementById('vehicle-selection');
        
        vehicleCount.addEventListener('change', updateVehicleSelection);
        updateVehicleSelection();
    }

    // Update vehicle selection boxes based on count
    function updateVehicleSelection() {
        const count = parseInt(document.getElementById('vehicle-count').value);
        const vehicleSelection = document.getElementById('vehicle-selection');
        
        vehicleSelection.innerHTML = '';
        selectedModels = Array(count).fill(null);
        
        for (let i = 0; i < count; i++) {
            const selectionBox = document.createElement('div');
            selectionBox.className = 'model-selector';
            selectionBox.innerHTML = `
                <div class="compact-layout">
                    <div class="vehicle-number">${i + 1}</div>
                    <div class="flex-1">
                        <div class="selection-row">
                            <div class="selection-group">
                                <label class="selection-label">Vehicle Type</label>
                                <select class="selection-dropdown vehicle-type-select" data-index="${i}" onchange="onVehicleTypeChange(${i})">
                                    <option value="">Select Type</option>
                                    ${vehicleTypes.map(type => 
                                        `<option value="${type.vehicle_type_id}">${type.vehicle_type_name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div class="selection-group">
                                <label class="selection-label">Brand</label>
                                <select class="selection-dropdown brand-select" data-index="${i}" onchange="onBrandChange(${i})" disabled>
                                    <option value="">Select Brand</option>
                                </select>
                            </div>
                            
                            <div class="selection-group">
                                <label class="selection-label">Model</label>
                                <select class="selection-dropdown model-select" data-index="${i}" onchange="onModelChange(${i})" disabled>
                                    <option value="">Select Model</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="selected-model-${i}" class="selected-model-display hidden">
                            <!-- Selected model will be shown here -->
                        </div>
                    </div>
                </div>
            `;
            vehicleSelection.appendChild(selectionBox);
        }
    }

    // Handle vehicle type change
    async function onVehicleTypeChange(index) {
        const vehicleTypeSelect = document.querySelector(`.vehicle-type-select[data-index="${index}"]`);
        const brandSelect = document.querySelector(`.brand-select[data-index="${index}"]`);
        const modelSelect = document.querySelector(`.model-select[data-index="${index}"]`);
        const selectedDisplay = document.getElementById(`selected-model-${index}`);
        
        const vehicleTypeId = vehicleTypeSelect.value;
        
        // Reset downstream selections
        brandSelect.innerHTML = '<option value="">Select Brand</option>';
        brandSelect.disabled = true;
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        modelSelect.disabled = true;
        selectedDisplay.classList.add('hidden');
        selectedModels[index] = null;
        
        if (!vehicleTypeId) return;
        
        try {
            // Fetch brands for selected vehicle type
            const response = await fetch(`/compare/brands/${vehicleTypeId}`);
            const data = await response.json();
            
            if (data.success) {
                brandSelect.innerHTML = '<option value="">Select Brand</option>' + 
                    data.brands.map(brand => 
                        `<option value="${brand.brand_id}">${brand.name}</option>`
                    ).join('');
                brandSelect.disabled = false;
            }
        } catch (error) {
            console.error('Error fetching brands:', error);
            alert('Error loading brands');
        }
    }

    // Handle brand change
    async function onBrandChange(index) {
        const vehicleTypeSelect = document.querySelector(`.vehicle-type-select[data-index="${index}"]`);
        const brandSelect = document.querySelector(`.brand-select[data-index="${index}"]`);
        const modelSelect = document.querySelector(`.model-select[data-index="${index}"]`);
        const selectedDisplay = document.getElementById(`selected-model-${index}`);
        
        const vehicleTypeId = vehicleTypeSelect.value;
        const brandId = brandSelect.value;
        
        // Reset downstream selections
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        modelSelect.disabled = true;
        selectedDisplay.classList.add('hidden');
        selectedModels[index] = null;
        
        if (!vehicleTypeId || !brandId) return;
        
        try {
            // Fetch models for selected brand and vehicle type
            const response = await fetch(`/compare/models/${vehicleTypeId}/${brandId}`);
            const data = await response.json();
            
            if (data.success) {
                modelSelect.innerHTML = '<option value="">Select Model</option>' + 
                    data.models.map(model => 
                        `<option value="${model.id}">${model.model_name}</option>`
                    ).join('');
                modelSelect.disabled = false;
            }
        } catch (error) {
            console.error('Error fetching models:', error);
            alert('Error loading models');
        }
    }

    // Handle model change
    async function onModelChange(index) {
        const modelSelect = document.querySelector(`.model-select[data-index="${index}"]`);
        const selectedDisplay = document.getElementById(`selected-model-${index}`);
        
        const modelId = modelSelect.value;
        
        if (!modelId) {
            selectedDisplay.classList.add('hidden');
            selectedModels[index] = null;
            return;
        }
        
        try {
            // Fetch model details
            const response = await fetch(`/compare/model/${modelId}`);
            const data = await response.json();
            
            if (data.success) {
                const model = data.model;
                selectedModels[index] = model;
                
                selectedDisplay.innerHTML = `
                    <div class="flex items-center">
                        <img src="${model.model_image || '/images/placeholder.jpg'}" 
                             alt="${model.model_name}" 
                             class="selected-model-image"
                             onerror="this.src='/images/placeholder.jpg'">
                        <div class="flex-1">
                            <div class="font-semibold text-sm">${model.brand_name} ${model.model_name}</div>
                            <div class="text-red-600 text-xs">
                                ${model.starting_price ? '₹' + new Intl.NumberFormat('en-IN').format(model.starting_price) : 'Price not available'}
                            </div>
                        </div>
                    </div>
                    <button class="remove-model-btn" onclick="removeModel(${index})">
                        Remove
                    </button>
                `;
                selectedDisplay.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error fetching model details:', error);
            alert('Error loading model details');
        }
    }

    // Remove selected model
    function removeModel(index) {
        const vehicleTypeSelect = document.querySelector(`.vehicle-type-select[data-index="${index}"]`);
        const brandSelect = document.querySelector(`.brand-select[data-index="${index}"]`);
        const modelSelect = document.querySelector(`.model-select[data-index="${index}"]`);
        const selectedDisplay = document.getElementById(`selected-model-${index}`);
        
        // Reset all selections for this box
        vehicleTypeSelect.value = '';
        brandSelect.innerHTML = '<option value="">Select Brand</option>';
        brandSelect.disabled = true;
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        modelSelect.disabled = true;
        selectedDisplay.classList.add('hidden');
        selectedModels[index] = null;
    }

    // Setup event listeners
    function setupEventListeners() {
        document.getElementById('compare-button').addEventListener('click', performComparison);
        document.getElementById('share-button').addEventListener('click', shareComparison);
    }

    // Perform comparison
    async function performComparison() {
        const selectedCount = selectedModels.filter(model => model !== null).length;
        
        if (selectedCount < 2) {
            alert('Please select at least 2 vehicles to compare');
            return;
        }

        // Show loading spinner
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('comparison-results').style.display = 'none';

        try {
            const modelIds = selectedModels.filter(model => model !== null).map(model => model.id);
            
            const response = await fetch('/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ modelIds: modelIds })
            });

            const data = await response.json();
            
            if (data.success) {
                displayComparisonResults(data.comparisonData);
                if (data.popularModels) {
                    displayRecommendedVehicles(data.popularModels);
                }
            } else {
                alert(data.message || 'Error performing comparison');
            }
        } catch (error) {
            console.error('Comparison error:', error);
            alert('Error performing comparison');
        } finally {
            document.getElementById('loading-spinner').style.display = 'none';
        }
    }

    // Display comparison results
    function displayComparisonResults(comparisonData) {
        const resultsSection = document.getElementById('comparison-results');
        const comparisonHeader = document.getElementById('comparison-header');
        const comparisonBody = document.getElementById('comparison-body');
        const conclusionContent = document.getElementById('conclusion-content');
        const comparisonTitle = document.getElementById('comparison-title');
        const scoreRow = document.querySelector('tfoot tr');
        
        // Update title with compared vehicles
        const titleModels = comparisonData.models.map(model => `${model.brand} ${model.name}`).join(' vs ');
        comparisonTitle.textContent = `Comparing ${titleModels}`;

        // Clear previous results
        comparisonHeader.innerHTML = '<th class="vehicle-header">Specifications</th>';
        comparisonBody.innerHTML = '';
        
        // Create table headers - Brand name and Model name only
        comparisonData.models.forEach((model, index) => {
            const headerCell = document.createElement('th');
            headerCell.className = 'vehicle-header';
            if (index === 0) {
                headerCell.classList.add('winner-cell');
            }
            headerCell.innerHTML = `
                <div class="vehicle-name">${model.brand}</div>
                <div class="vehicle-brand">${model.name}</div>
            `;
            comparisonHeader.appendChild(headerCell);
        });

        // Create specification rows
        comparisonData.specifications.forEach(spec => {
            const row = document.createElement('tr');
            row.className = 'spec-row';
            
            const specNameCell = document.createElement('td');
            specNameCell.className = 'spec-name';
            specNameCell.textContent = spec;
            row.appendChild(specNameCell);
            
            comparisonData.models.forEach(model => {
                const specValueCell = document.createElement('td');
                specValueCell.className = 'spec-value';
                
                // Use includes instead of has for array
                if (model.specs.includes(spec)) {
                    specValueCell.innerHTML = '<span class="tick">✓</span>';
                } else {
                    specValueCell.innerHTML = '<span class="cross">✗</span>';
                }
                
                row.appendChild(specValueCell);
            });
            
            comparisonBody.appendChild(row);
        });

        // Add score row to footer
        scoreRow.innerHTML = '<td class="spec-name font-bold text-lg">Total Score</td>';
        
        comparisonData.models.forEach(model => {
            const scoreCell = document.createElement('td');
            scoreCell.className = 'spec-value score-cell';
            
            // Fix: Ensure score doesn't exceed total specifications
            const actualScore = Math.min(model.score, comparisonData.totalSpecifications);
            scoreCell.textContent = `${actualScore}/${comparisonData.totalSpecifications}`;
            scoreRow.appendChild(scoreCell);
        });

        // Generate conclusion
        generateConclusion(comparisonData, conclusionContent);
        
        // Show results section
        resultsSection.style.display = 'block';
        
        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Generate conclusion
    function generateConclusion(comparisonData, container) {
        // Sort models by score in descending order
        const sortedModels = [...comparisonData.models].sort((a, b) => b.score - a.score);
        const winner = sortedModels[0];
        
        // Fix: Ensure score doesn't exceed total specifications
        const winnerScore = Math.min(winner.score, comparisonData.totalSpecifications);
        const winnerPercentage = Math.round((winnerScore / comparisonData.totalSpecifications) * 100);
        
        let conclusionHTML = `
            <div class="mb-4">
                <h4 class="text-lg font-semibold winner-text mb-2">${winner.brand} ${winner.name} - Winner</h4>
                <p class="text-white">The <span class="winner-text">${winner.brand} ${winner.name}</span> leads with <span class="winner-text">${winnerPercentage}%</span> of specifications met, scoring <span class="winner-text">${winnerScore}</span> out of <span class="winner-text">${comparisonData.totalSpecifications}</span> total specifications.</p>
            </div>
        `;

        if (sortedModels.length > 1) {
            conclusionHTML += `<div class="mb-4">
                <h4 class="text-lg font-semibold text-white mb-2">Ranking Summary</h4>
                <ul class="list-disc list-inside text-white space-y-1">`;
            
            sortedModels.forEach((model, index) => {
                const position = index === 0 ? '1st' : index === 1 ? '2nd' : index === 2 ? '3rd' : '4th';
                const modelScore = Math.min(model.score, comparisonData.totalSpecifications);
                const modelPercentage = Math.round((modelScore / comparisonData.totalSpecifications) * 100);
                
                if (index === 0) {
                    conclusionHTML += `<li><span class="winner-text">${position} Place: ${model.brand} ${model.name} (${modelPercentage}%) - WINNER</span></li>`;
                } else {
                    conclusionHTML += `<li>${position} Place: ${model.brand} ${model.name} (${modelPercentage}%)</li>`;
                }
            });
            
            conclusionHTML += `</ul></div>`;
        }

        // Missing specifications for winner
        const missingSpecs = comparisonData.specifications.filter(spec => !winner.specs.includes(spec));
        if (missingSpecs.length > 0) {
            conclusionHTML += `
                <div class="mb-4">
                    <h4 class="text-lg font-semibold text-white mb-2">Considerations for ${winner.brand} ${winner.name}</h4>
                    <p class="text-white mb-2">The ${winner.brand} ${winner.name} is missing the following specifications that you might want to consider:</p>
                    <div class="text-sm text-white bg-black rounded p-3 border border-white">
                        ${missingSpecs.slice(0, 8).join(', ')}${missingSpecs.length > 8 ? ` and ${missingSpecs.length - 8} more...` : ''}
                    </div>
                </div>
            `;
        }

        // Recommendations
        conclusionHTML += `
            <div class="mt-6">
                <h4 class="text-lg font-semibold text-white mb-2">Recommendation</h4>
                <p class="text-white">
                    Based on your comparison, the <strong class="winner-text">${winner.brand} ${winner.name}</strong> offers the best overall specifications. 
                    ${missingSpecs.length > 0 ? 'However, consider if the missing features are important for your needs.' : 'It provides comprehensive features across all categories.'}
                </p>
            </div>
        `;

        container.innerHTML = conclusionHTML;
    }

    // Share comparison
    function shareComparison() {
        const comparisonUrl = window.location.href;
        
        if (navigator.share) {
            navigator.share({
                title: 'Vehicle Comparison - Gyarage',
                text: 'Check out this vehicle comparison I created on Gyarage',
                url: comparisonUrl,
            })
            .catch(error => console.log('Error sharing:', error));
        } else {
            // Fallback: Copy to clipboard
            navigator.clipboard.writeText(comparisonUrl).then(() => {
                alert('Comparison link copied to clipboard!');
            });
        }
    }

    // Load recommended vehicles
    function loadRecommendedVehicles() {
        // This would show initial recommendations
        // Actual recommendations will be updated after comparison
        const container = document.getElementById('recommended-vehicles');
        container.innerHTML = '<div class="col-span-full text-center text-white">Select vehicles to compare to see recommendations</div>';
    }

    // Display recommended vehicles
    function displayRecommendedVehicles(vehicles) {
        const container = document.getElementById('recommended-vehicles');
        container.innerHTML = '';
        
        if (!vehicles || vehicles.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center text-white">No recommendations available</div>';
            return;
        }
        
        vehicles.forEach(vehicle => {
            const card = document.createElement('div');
            card.className = 'recommendation-card';
            card.innerHTML = `
                <img src="${vehicle.model_image || '/images/placeholder.jpg'}" 
                     alt="${vehicle.model_name}" 
                     class="w-full h-32 object-cover rounded-lg mb-3 border border-white"
                     onerror="this.src='/images/placeholder.jpg'">
                <div class="font-semibold text-center text-white">${vehicle.brand_name} ${vehicle.model_name}</div>
                <div class="text-red-600 font-bold text-center mt-2">
                    ${vehicle.starting_price ? '₹' + new Intl.NumberFormat('en-IN').format(vehicle.starting_price) : 'Price not available'}
                </div>
                <a href="/modeldetails/${vehicle.id}" class="block text-center mt-3 compare-button py-2 px-4 rounded transition duration-300">
                    Check Details
                </a>
            `;
            container.appendChild(card);
        });
    }
</script>
</body>
</html>